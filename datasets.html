{% extends "base.html" %} {% block title %}Datasets - Reconciliation Tool{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>Dataset Management</h1>
  <button class="btn btn-primary" onclick="showModal('uploadModal')">
    <i class="fas fa-upload"></i> Upload Dataset
  </button>
</div>

<!-- Search and Filter -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row">
      <div class="col-6">
        <div class="form-group">
          <label class="form-label" for="searchDatasets">Search Datasets</label>
          <input
            type="text"
            id="searchDatasets"
            class="form-control"
            placeholder="Search"
          />
        </div>
      </div>
      <div class="col-3">
        <div class="form-group">
          <label class="form-label" for="sortBy">Sort By</label>
          <select id="sortBy" class="form-control form-select">
            <option value="upload_date">Upload Date</option>
            <option value="name">Name</option>
            <option value="runs_count">Number of Runs</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Datasets Grid -->
<div id="datasetsGrid">
  <div class="text-center p-3">
    <i
      class="fas fa-spinner fa-spin"
      style="font-size: 2rem; color: var(--hsbc-primary)"
    ></i>
    <p>Loading datasets...</p>
  </div>
</div>

<!-- Upload Dataset Modal -->
<div id="uploadModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Upload New Dataset</h3>
      <button class="modal-close" onclick="hideModal('uploadModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="uploadForm">
        <div class="form-group">
          <label class="form-label" for="datasetName">Name</label>
          <input
            type="text"
            id="datasetName"
            class="form-control"
            placeholder="Enter Dataset Name"
            required
          />
        </div>

        <div
          class="upload-area"
          id="uploadArea"
          style="
            border: 2px dashed var(--hsbc-primary);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
          "
        >
          <i
            class="fas fa-cloud-upload-alt"
            style="
              font-size: 3rem;
              color: var(--hsbc-primary);
              margin-bottom: 1rem;
            "
          ></i>
          <p style="margin-bottom: 1rem">
            Drag and drop your CSV file here, or click to browse
          </p>
          <input
            type="file"
            id="fileInput"
            accept=".csv"
            style="display: none"
            required
          />
          <button
            type="button"
            class="btn btn-outline"
            onclick="document.getElementById('fileInput').click()"
          >
            Choose File
          </button>
          <div id="selectedFile" style="margin-top: 1rem; display: none">
            <i class="fas fa-file-csv" style="color: var(--hsbc-teal)"></i>
            <span id="fileName"></span>
          </div>
        </div>

        <div id="uploadProgress" style="display: none; margin-top: 1rem">
          <div
            style="
              background-color: var(--light-gray);
              height: 20px;
              overflow: hidden;
            "
          >
            <div
              id="progressBar"
              style="
                background-color: var(--hsbc-teal);
                height: 100%;
                width: 0%;
                transition: width 0.3s ease;
              "
            ></div>
          </div>
          <p id="progressText" style="margin-top: 0.5rem; text-align: center">
            Uploading...
          </p>
        </div>

        <div class="d-flex justify-content-between mt-3">
          <button
            type="button"
            class="btn btn-outline"
            onclick="hideModal('uploadModal')"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Upload Dataset</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div id="viewDatasetModal" class="modal">
  <div
    class="modal-content"
    style="width: 80%; max-width: 1400px; height: 85vh"
  >
    <div class="modal-header">
      <h3 id="viewDatasetModalTitle">Dataset Preview</h3>
      <button class="modal-close" onclick="hideModal('viewDatasetModal')">
        &times;
      </button>
    </div>
    <div
      class="modal-body"
      style="
        padding: 0;
        display: flex;
        flex-direction: column;
        height: calc(100% - 60px);
      "
    >
      <perspective-viewer
        id="datasetViewer"
        style="flex: 1"
      ></perspective-viewer>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script type="module">
  import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer@3.7.4/dist/cdn/perspective-viewer.js";
  import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid@3.7.4/dist/cdn/perspective-viewer-datagrid.js";
  import "https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc@3.7.4/dist/cdn/perspective-viewer-d3fc.js";

  import perspective from "https://cdn.jsdelivr.net/npm/@finos/perspective@3.7.4/dist/cdn/perspective.js";

  let worker = await perspective.worker();
  window.worker = worker;
</script>
<script>
  let allDatasets = [];
  let filteredDatasets = [];

  document.addEventListener("DOMContentLoaded", function () {
    loadDatasets();
    setupSearchAndFilter();
    setupFileUpload();
    setupUploadForm();
  });

  async function loadDatasets() {
    try {
      const datasets = await apiCall("/api/datasets");
      allDatasets = datasets;
      filteredDatasets = [...datasets];
      renderDatasets(filteredDatasets);
    } catch (error) {
      console.error("Failed to load datasets:", error);
      document.getElementById("datasetsGrid").innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--hsbc-red);"></i>
                <p style="color: var(--hsbc-red);">Failed to load datasets</p>
            </div>
        `;
    }
  }

  function renderDatasets(datasets) {
    const container = document.getElementById("datasetsGrid");

    if (datasets.length === 0) {
      container.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-database" style="font-size: 3rem; color: var(--gray);"></i>
                <h3 style="color: var(--gray); margin-top: 1rem;">No datasets found</h3><br/>
                <button class="btn btn-primary" onclick="showModal('uploadModal')">
                    <i class="fas fa-upload"></i> Upload Dataset
                </button>
            </div>
        `;
      return;
    }

    container.innerHTML = `
        <div class="row">
            ${datasets
              .map(
                (dataset) => `
                <div class="col-4">
                    <div class="card" style="height: 100%;">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 style="margin: 0;">${dataset.name}</h4>
                                <i class="fas fa-database" style="color: var(--hsbc-teal);"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>ID:</strong><br>
                                <code style="font-size: 0.875rem; background-color: var(--light-gray); padding: 0.25rem; border-radius: 0px;">${dataset.id}</code>
                            </div>

                            <div class="mb-3">
                                <strong>Uploaded By:</strong><br>
                                <i class="fas fa-user"></i> ${dataset.uploaded_by}
                            </div>

                            <div class="mb-3">
                                <strong>Number of Runs:</strong><br>
                                <i class="fas fa-play"></i> ${dataset.runs_count} runs
                            </div>

                            <div class="mb-3">
                                <strong>Upload Date:</strong><br>
                                <i class="fas fa-clock"></i> ${formatDate(dataset.upload_date)}
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-outline" style="flex: 1;" onclick="viewDataset('${dataset.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="useInRun('${dataset.name}')">
                                    <i class="fas fa-play"></i> Use in Run
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `,
              )
              .join("")}
        </div>
    `;
  }

  function setupSearchAndFilter() {
    const searchInput = document.getElementById("searchDatasets");
    // const classificationFilter = document.getElementById(
    //   "filterClassification",
    // );
    const sortSelect = document.getElementById("sortBy");

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      // const classification = classificationFilter.value;
      const sortBy = sortSelect.value;

      // Filter
      filteredDatasets = allDatasets.filter((dataset) => {
        const matchesSearch = dataset.name.toLowerCase().includes(searchTerm);

        return matchesSearch;
      });

      // Sort
      filteredDatasets.sort((a, b) => {
        switch (sortBy) {
          case "name":
            return a.name.localeCompare(b.name);
          case "runs_count":
            return b.runs_count - a.runs_count;
          case "upload_date":
          default:
            return new Date(b.upload_date) - new Date(a.upload_date);
        }
      });

      renderDatasets(filteredDatasets);
    }

    searchInput.addEventListener("input", applyFilters);
    //classificationFilter.addEventListener("change", applyFilters);
    sortSelect.addEventListener("change", applyFilters);
  }

  function setupFileUpload() {
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const selectedFile = document.getElementById("selectedFile");
    const fileName = document.getElementById("fileName");

    uploadArea.addEventListener("dragover", function (e) {
      e.preventDefault();
      uploadArea.style.backgroundColor = "var(--hsbc-light)";
      uploadArea.style.borderColor = "var(--hsbc-teal)";
    });

    uploadArea.addEventListener("dragleave", function (e) {
      e.preventDefault();
      uploadArea.style.backgroundColor = "transparent";
      uploadArea.style.borderColor = "var(--hsbc-primary)";
    });

    uploadArea.addEventListener("drop", function (e) {
      e.preventDefault();
      uploadArea.style.backgroundColor = "transparent";
      uploadArea.style.borderColor = "var(--hsbc-primary)";

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        showSelectedFile(files[0]);
      }
    });

    fileInput.addEventListener("change", function (e) {
      if (e.target.files.length > 0) {
        showSelectedFile(e.target.files[0]);
      }
    });

    function showSelectedFile(file) {
      fileName.textContent = file.name;
      selectedFile.style.display = "block";

      const nameInput = document.getElementById("datasetName");
      if (!nameInput.value) {
        nameInput.value = file.name.replace(".csv", "").replace(/[_-]/g, " ");
      }
    }
  }

  function setupUploadForm() {
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file || !file.name.endsWith(".csv")) {
        alert("Please select a CSV file");
        return;
      }

      const datasetName = document.getElementById("datasetName").value;
      // const classification = document.getElementById(
      //   "datasetClassification",
      // ).value;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("name", datasetName);

      const progressDiv = document.getElementById("uploadProgress");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const submitButton = form.querySelector('button[type="submit"]');

      progressDiv.style.display = "block";
      submitButton.disabled = true;
      submitButton.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Uploading...';

      try {
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 30;
          if (progress > 90) progress = 90;
          progressBar.style.width = progress + "%";
          progressText.textContent = `Uploading... ${Math.round(progress)}%`;
        }, 200);

        const response = await fetch("/api/datasets/upload", {
          method: "POST",
          body: formData,
        });

        clearInterval(progressInterval);

        if (response.ok) {
          progressBar.style.width = "100%";
          progressText.textContent = "Upload complete!";

          setTimeout(() => {
            hideModal("uploadModal");
            form.reset();
            progressDiv.style.display = "none";
            document.getElementById("selectedFile").style.display = "none";
            loadDatasets();
          }, 1000);
        } else {
          throw new Error("Upload failed");
        }
      } catch (error) {
        console.error("Upload error:", error);
        progressText.textContent = "Upload failed!";
        progressBar.style.backgroundColor = "var(--hsbc-red)";
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-upload"></i> Upload Dataset';
      }
    });
  }

  function GetElementInsideContainer(containerID, childID) {
    var elm = document.getElementById(childID);
    var parent = elm ? elm.parentNode : {};
    return parent.id && parent.id === containerID ? elm : {};
  }

  async function viewDataset(datasetId) {
    const dataset = allDatasets.find((d) => d.id === datasetId);

    if (!dataset) {
      console.error("Dataset not found:", datasetId);
      return;
    }
    const modalTitle = document.getElementById("viewDatasetModalTitle");
    const viewer = document.getElementById("datasetViewer");

    modalTitle.textContent = `Preview: ${dataset.name}`;

    if (viewer.table) {
      await viewer.delete();
    }
    viewer.innerHTML = `
          <div class="text-center p-5 d-flex flex-column justify-content-center align-items-center" style="height: 100%;">
              <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--hsbc-primary);"></i>
              <p class="mt-3">Loading Data...</p>
          </div>
      `;

    showModal("viewDatasetModal");

    try {
      const table = await window.worker.table(dataset.data);
      await viewer.load(table);

      await viewer.restore({
        plugin: "Datagrid",
        settings: false,
        plugin_config: { edit_mode: "READ_ONLY" },
      });
    } catch (error) {
      console.error("Failed to load data into perspective viewer:", error);
      viewer.innerHTML = `
              <div class="text-center p-5 d-flex flex-column justify-content-center align-items-center" style="height: 100%;">
                  <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--hsbc-red);"></i>
                  <p class="mt-3" style="color: var(--hsbc-red);">Failed to load data preview.</p>
              </div>
          `;
    }
  }
  function useInRun(datasetName) {
    // Redirect to dashboard with dataset pre-selected
    window.location.href = `/?dataset=${encodeURIComponent(datasetName)}`;
  }
</script>
{% endblock %}
